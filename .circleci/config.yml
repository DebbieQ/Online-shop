version: 2.1

jobs:
  build-and-test:
    working_directory: ~/repo/peng
    docker:
      - image: python:3.7.3-stretch
    steps:
      - checkout:
          path: ~/repo
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "requirements.txt" }}
            - v1-dependencies-
      - run:
          name: install dependencies
          command: |
            # Setup virtualenv
            make setup
            # Install project dependencies
            make install
      - save_cache:
          paths:
            - ./.devops
          key: v1-dependencies-{{ checksum "requirements.txt" }}
      - run:
          name: run lint
          command: |
            make lint
  deploy_app:
    environment:
       imageName: my-app 
    # working_directory: /root/repo/peng
    # specity what will execute steps
    docker:
      - image: cimg/python:3.10.0-node
        # auth:
        #   # Environmental variables set from $context_name context
        #   username: $DOCKERHUB_USERNAME
        #   password: $DOCKERHUB_PASSWORD
    
    steps:
      - checkout
      - setup_remote_docker:
          version: 19.03.13
          docker_layer_caching: true

      - run:
          name: Build, tag and push image
          command: |
            docker image build -f peng/Dockerfile -t my-app .
            docker images
            docker run -p 80:80 -d my-app 
            dockerpath=debbiequarsh/my-app
            echo "Docker ID and Image: $dockerpath"
            docker login -u $DOCKERHUB_USERNAME -p $DOCKERHUB_PASSWORD && docker tag $dockerpath $dockerpath:latest
            docker push $dockerpath:latest

            # docker build -f peng/Dockerfile -t $imageName .
            # docker tag $imageName $DOCKERHUB_USERNAME/$imageName
            # echo "$DOCKERHUB_PASSWORD" | docker login -u $DOCKER_USERNAME --password-stdin
            # docker push $DOCKERHUB_USERNAME/$imageName
  kubernetes-deploy:
    docker:
      - image: cimg/python:3.10.0-node
    steps:
      - checkout
      - add_ssh_keys:
          fingerprints: ["ca:ba:01:a0:d0:40:ab:93:7f:d8:88:c6:03:8b:a1:89"]
      - run:
          name: Create deployment and service
          command: |
            ssh mast@192.168.101.211
            ls
            kubectl create -f deployment.yml -n peng --create-namespace
            kubectl describe po -n peng
            kubectl create -f deployment-service.yml 

workflows:
  default:
    jobs:
      - build-and-test
      - deploy_app:
          requires: [build-and-test]
          # context:
          #   - docker credentials
      - kubernetes-deploy:
          requires: [deploy_app]
